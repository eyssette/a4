<!DOCTYPE html>
<html>
<head>
	<title>Mise en forme automatique au format A4</title>
	<meta charset="utf-8">
	<style>h1, p{text-align:center}textarea{width:95%;max-width:800px;display:block;margin:auto;margin-top:30px;height:300px;font-family:monospace;font-size:14px;}button{margin:auto; display: block; margin-top: 20px}</style>
</head>
<body>
	<h1>Mise en forme automatique au format A4</h1>
	<p>Copier-coller votre markdown ici et cliquer sur le bouton “Convertir”</p>
	<textarea id="input"></textarea>
	<button onclick="convert()">Convertir</button>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.2/purify.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
	<script>
		function convert() {
			const input = document.getElementById("input").value;
			const yamlRegex = /^---\n([\s\S]*?)\n---\n/;
			const match = input.match(yamlRegex);
			const yaml = match ? match[1] : null;
			const mdWithoutYaml = input.replace(yamlRegex, "")
			const html = DOMPurify.sanitize(marked.parse(mdWithoutYaml));
			let params
			if (yaml) {
				params = jsyaml.load(yaml);
			}
			const pattern1 = new RegExp(/\s(;!%\?:€»)/, "g");
			const pattern2 = new RegExp(/(«)\s/, "g");
			const htmlNbsp = html.replaceAll(' !','&nbsp;!').replaceAll(' ?','&nbsp;?').replaceAll(' ;','&nbsp;;').replaceAll(' :','&nbsp;:').replaceAll(' »','&nbsp;»').replaceAll('« ','«&nbsp;');
			let copies = "";
			if (yaml && typeof params.copies != "undefined") {
				for (let index = 0; index < params.copies ; index++) {
					copies = copies + htmlNbsp;
				}
			}

			const template = `<!DOCTYPE html>
			<html>
			<head>
				<title>Markdown to HTML Result</title>
				<meta charset="utf-8">
				<style>h2,h3,h4,h5,h6{break-after:avoid}body{font-family:Garamond,Philosopher,"Times New Roman",Times,serif;text-align:justify;line-height:1.15;column-gap:25px;orphans:5}h1{font-size:1.2em;text-align:center;margin-bottom:1em}h2{font-size:1.05em;margin-top:1em!important;margin-bottom:.5em!important}body>h2:first-child{margin-top:0!important}h3,h4,h5,h6{font-size:1em;margin-top:.75em;margin-bottom:.5em;font-weight:400}h3{text-decoration:underline}code{color:#000!important;font-size:100%;font-variant:small-caps;font-family:inherit;background:0 0!important}ol,ul{padding-left:15px}p{margin-top:0.5em}
				*{margin:0;overflow-wrap: break-word;}body{font-size:100px;width:21cm;margin:10px;padding:0}@media print{@page{size:A4;margin:10px;}body{margin:auto}}
				${(yaml && typeof params.columns !== "undefined" ? "body{ columns:"+params.columns+"}": "")}
				${(yaml && typeof params.colonnes !== "undefined" ? "body{ columns:"+params.colonnes+"}": "")}
				${(yaml && typeof params.espacementColonnes !== "undefined" ? "body{ column-gap:"+params.espacementColonnes+"}": "")}
				${(yaml && typeof params.columnGap !== "undefined" ? "body{ column-gap:"+params.columnGap+"}": "")}
				${(yaml && typeof params.paysage !== "undefined" || yaml && typeof params.landscape !== "undefined" ? "body{ width:29.7cm!important}@media print{@page{size:A4 landscape!important;}}": "")}
				</style>
				${(yaml && typeof params.maths !== "undefined" && params.maths === true ? "<script src=\"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js\" type=\"text/javascript\"><\/script>" : "")}
				<script>
				${(yaml && typeof params.pages !== "undefined" ? "let nPages = "+params.pages+"; ": "let nPages=1; ")}	
			let fontSize = 100;
				${(yaml && typeof params.paysage !== "undefined" || yaml && typeof params.landscape !== "undefined" ? "let maxHeight = 774*nPages": "let maxHeight = 1025*nPages; ")}
			let stepReduceFontSize = maxHeight * 2.5;
			let ratio;
			let trackReduction = 0
			function adjustFontSize() {
				let newFontSize = fontSize;
				let start = null;
				function update(timestamp) {
					if (!start) start = timestamp;
					let newContentHeight = document.body.clientHeight;
					if (newContentHeight > maxHeight) {
						ratio = newContentHeight / stepReduceFontSize
						newFontSize -= ratio;
						${(yaml && typeof params.maths !== "undefined" && params.maths === true ? "": "if (newFontSize > trackReduction) {")}
							document.body.style.fontSize = newFontSize + "px";
							${(yaml && typeof params.maths !== "undefined" && params.maths === true ? "": "}")}
						trackReduction = newFontSize
						start = timestamp;
						
					} else if (newFontSize !== fontSize) {
						fontSize = newFontSize;
						document.body.style.fontSize = fontSize + "px"
					}
					if (newFontSize > 0) {
						requestAnimationFrame(update);
					}
				}
				requestAnimationFrame(update);
			}
			window.addEventListener("load", adjustFontSize);
			window.addEventListener("resize", adjustFontSize);
			<\/script>
			</head>
			<body>
				${(yaml && typeof params.copies !== "undefined" ? copies : htmlNbsp)}
			</body>
			</html>`;
			const result = window.open();
			result.document.write(template);
			result.document.close();
		}
	</script>
</body>
</html>